---
import BaseLayout from '../layouts/BaseLayout.astro';
import Header from '../components/Header.astro';

const code501 = `type Rover = {
  heading: string;
  x: number;
  y: number;
};

// Consolidated direction mappings
const DIRECTIONS = ['N', 'E', 'S', 'W'] as const;
const DIRECTION_DELTAS = { N: [0, 1], E: [1, 0], S: [0, -1], W: [-1, 0] } as const;

function executeCommand(rover: Rover, command: string): void {
  switch (command) {
    case 'M':
      const [dx, dy] = DIRECTION_DELTAS[rover.heading];
      rover.x += dx;
      rover.y += dy;
      break;
    case 'L':
      const leftIndex = (DIRECTIONS.indexOf(rover.heading as any) + 3) % 4;
      rover.heading = DIRECTIONS[leftIndex];
      break;
    case 'R':
      const rightIndex = (DIRECTIONS.indexOf(rover.heading as any) + 1) % 4;
      rover.heading = DIRECTIONS[rightIndex];
      break;
  }
}

export function commandRover(rawInstructions: string): string {
  const lines = rawInstructions.split("\\n");
  const results: string[] = [];

  for (let i = 1; i < lines.length; i += 2) {
    const [x, y, heading] = lines[i].split(" ");
    const rover: Rover = { x: parseInt(x), y: parseInt(y), heading };

    for (const command of lines[i + 1]) {
      executeCommand(rover, command);
    }

    results.push(\`\${rover.x} \${rover.y} \${rover.heading}\`);
  }

  return results.join("\\n");
}`;

const code488 = `type Rover = { heading: string; x: number; y: number };

// Optimized lookup tables
const DIRS = ['N', 'E', 'S', 'W'];
const MOVES = { N: [0, 1], E: [1, 0], S: [0, -1], W: [-1, 0] };
const TURNS = { L: -1, R: 1 };

export function commandRover(instructions: string): string {
  const lines = instructions.split("\\n");
  const results = [];

  for (let i = 1; i < lines.length; i += 2) {
    const [x, y, h] = lines[i].split(" ");
    let rover = { x: +x, y: +y, heading: h };
    let dirIndex = DIRS.indexOf(h);

    for (const cmd of lines[i + 1]) {
      if (cmd === 'M') {
        const [dx, dy] = MOVES[rover.heading];
        rover.x += dx;
        rover.y += dy;
      } else {
        dirIndex = (dirIndex + TURNS[cmd] + 4) % 4;
        rover.heading = DIRS[dirIndex];
      }
    }

    results.push(\`\${rover.x} \${rover.y} \${rover.heading}\`);
  }

  return results.join("\\n");
}`;

const code412 = `const D = ['N', 'E', 'S', 'W'];
const M = [[0, 1], [1, 0], [0, -1], [-1, 0]];

export function commandRover(s: string): string {
  const l = s.split("\\n");
  let r = [];

  for (let i = 1; i < l.length; i += 2) {
    let [x, y, d] = l[i].split(" ");
    let [px, py, di] = [+x, +y, D.indexOf(d)];

    for (let c of l[i + 1]) {
      if (c === 'M') {
        px += M[di][0];
        py += M[di][1];
      } else {
        di = (di + (c === 'L' ? 3 : 1)) % 4;
      }
    }

    r.push(\`\${px} \${py} \${D[di]}\`);
  }

  return r.join("\\n");
}`;

const code374 = `const DIRECTIONS = 'NESW';
const DELTA_X = [0, 1, 0, -1];
const DELTA_Y = [1, 0, -1, 0];

export function commandRover(instructions: string): string {
  const lines = instructions.split("\\n");
  const results = [];

  for (let i = 1; i < lines.length; i += 2) {
    const parts = lines[i].split(" ");
    let posX = +parts[0];
    let posY = +parts[1];
    let dirIndex = DIRECTIONS.indexOf(parts[2]);

    for (const command of lines[i + 1]) {
      if (command === 'M') {
        posX += DELTA_X[dirIndex];
        posY += DELTA_Y[dirIndex];
      } else {
        dirIndex = (dirIndex + (command === 'L' ? 3 : 1)) % 4;
      }
    }

    results.push(\`\${posX} \${posY} \${DIRECTIONS[dirIndex]}\`);
  }

  return results.join("\\n");
}`;
---

<BaseLayout title="Boltzmann Analyser - Lexical Complexity Analysis">
  <Header registerHref="#register" />

  <!-- Hero Section -->
  <section class="hero">
    <div class="container">
      <div class="hero-content">
        <h2 class="hero-title">
          <span class="highlight">Lexical Complexity</span> Analysis
        </h2>
        <p class="hero-description">
          Static analysis of software and software projects to help you
          identify where complexity lives in your system and guide you through
          effective refactors.
        </p>
        <div class="hero-cta">
          <a href="#register" class="btn-primary">Register Your Interest</a>
          <a href="#explanation" class="btn-secondary">Learn More</a>
        </div>
      </div>
      <div class="hero-visual">
        <div class="interface-preview">
          <div class="screenshot-container" id="screenshot-trigger">
            <img
              src="/images/boltzmann-interface-screenshot.png"
              alt="Boltzmann Analyser Interface Screenshot"
              class="interface-screenshot"
            />
            <div class="screenshot-overlay">
              <div class="overlay-badge">
                <span class="badge-text">Live Interface Preview</span>
                <span class="click-hint">Click to enlarge</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <section id="explanation" class="explanation">
    <div class="container">
      <h2 class="section-title">What is Lexical Complexity?</h2>

      <!-- Video Section -->
      <div class="video-section">
        <div class="video-embed-container">
          <iframe
            width="560"
            height="315"
            src="https://www.youtube.com/embed/rCxbM3IX0X4?si=gfgpbZA9n1GQOBfJ"
            title="YouTube video player"
            frameborder="0"
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
            referrerpolicy="strict-origin-when-cross-origin"
            allowfullscreen
          >
          </iframe>
        </div>
      </div>
    </div>
  </section>

  <!-- Code Comparison Section -->
  <section class="code-comparison">
    <div class="code-comparison-header">
      <h2 class="section-title">
        What do different complexity levels look like?
      </h2>
    </div>
    <div class="code-comparison-description">
      <p class="section-description">
        Below are 4 implementations of the
        <a href="https://kata-log.rocks/mars-rover-kata">mars rover kata</a>
        written by claude. I asked claude to refactor using lexical complexity
        as a heuristic to optimise against. After 374 complexity, it was
        unable to find a less complex version, although minor optimisations
        are still possible.
        <br />
        <br />
        Click the boxes to view the code more easily
      </p>
    </div>

    <div class="code-grid">
      <div class="code-column">
        <h3 class="code-title">501 Complexity</h3>
        <div class="code-block" data-title="501 Complexity">
          <pre><code class="language-typescript" set:text={code501}></code></pre>
        </div>
      </div>

      <div class="code-column">
        <h3 class="code-title">488 Complexity</h3>
        <div class="code-block" data-title="488 Complexity">
          <pre><code class="language-typescript" set:text={code488}></code></pre>
        </div>
      </div>

      <div class="code-column">
        <h3 class="code-title">412 Complexity</h3>
        <div class="code-block" data-title="412 Complexity">
          <pre><code class="language-typescript" set:text={code412}></code></pre>
        </div>
      </div>

      <div class="code-column">
        <h3 class="code-title">374 Complexity</h3>
        <div class="code-block" data-title="374 Complexity">
          <pre><code class="language-typescript" set:text={code374}></code></pre>
        </div>
      </div>
    </div>
  </section>

  <!-- Registration Section -->
  <section id="register" class="register">
    <div class="container">
      <div class="register-content">
        <h2 class="section-title">Register Your Interest</h2>
        <form id="registrationForm" class="registration-form">
          <div class="form-group">
            <label for="name">Full Name *</label>
            <input type="text" id="name" name="name" required />
          </div>

          <div class="form-group">
            <label for="email">Email Address *</label>
            <input type="email" id="email" name="email" required />
          </div>

          <div class="form-group">
            <label for="company">Company/Organization</label>
            <input type="text" id="company" name="company" />
          </div>

          <div class="form-group">
            <label for="role">Your Role</label>
            <select id="role" name="role">
              <option value="">Select your role</option>
              <option value="developer">Software Developer</option>
              <option value="researcher">Researcher</option>
              <option value="analyst">Data Analyst</option>
              <option value="writer">Educator/Communicator</option>
              <option value="academic">Academic</option>
              <option value="other">Other</option>
            </select>
          </div>

          <div class="form-group">
            <label for="useCase">Primary Use Case</label>
            <textarea
              id="useCase"
              name="useCase"
              rows="3"
              placeholder="Tell us how you plan to use Boltzmann Analyser..."
            ></textarea>
          </div>

          <div class="form-group">
            <label for="languages">Programming Languages of Interest</label>
            <input
              type="text"
              id="languages"
              name="languages"
              placeholder="e.g., JavaScript, Python, Java, TypeScript..."
            />
          </div>

          <div class="form-group checkbox-group">
            <label class="checkbox-label">
              <input type="checkbox" id="updates" name="updates" checked />
              <span class="checkmark"></span>
              Send me product updates and early access notifications
            </label>
          </div>

          <button type="submit" class="btn-primary btn-full">
            Register Interest
          </button>
        </form>

        <div
          id="successMessage"
          class="success-message"
          style="display: none"
        >
          <div class="success-icon">âœ“</div>
          <h3>Almost There!</h3>
          <p>
            <strong>Important:</strong> An email has been generated in your
            email client.
            <strong
              >Please send that email to complete your registration.</strong
            >
          </p>
          <p>
            Once we receive your email, we'll add you to our mailing list and
            keep you updated on Boltzmann Analyser's progress.
          </p>
        </div>
      </div>
    </div>
  </section>

  <!-- Footer -->
  <footer class="footer">
    <div class="container">
      <div class="footer-content">
        <div class="footer-brand">
          <div class="footer-logo-container">
            <img
              src="/logo/Logo-white.png"
              alt="Boltzmann Analyser Logo"
              class="footer-logo"
            />
            <h3>Boltzmann Analyser</h3>
          </div>
          <p>A new way to look at code</p>
        </div>
        <div class="footer-links">
          <div class="footer-section">
            <h4>Product</h4>
            <a href="#register">Register Interest</a>
          </div>
          <div class="footer-section">
            <h4>Contact</h4>
            <a href="mailto:boltzmannanalyser@gmail.com"
              >boltzmannanalyser@gmail.com</a
            >
          </div>
        </div>
      </div>
      <div class="footer-bottom">
        <p>&copy; 2025 Boltzmann Analysis. All rights reserved.</p>
      </div>
    </div>
  </footer>

  <!-- Image Modal -->
  <div id="imageModal" class="modal">
    <div class="modal-content">
      <span class="modal-close">&times;</span>
      <img
        id="modalImage"
        class="modal-image"
        src="/images/boltzmann-interface-screenshot.png"
        alt="Boltzmann Analyser Interface - Full Size"
      />
    </div>
  </div>

  <!-- Code Modal -->
  <div id="code-modal" class="modal">
    <div class="modal-content code-modal-content">
      <span class="close" id="code-modal-close">&times;</span>
      <pre id="code-modal-content"><code></code></pre>
    </div>
  </div>

  <script>
    // Smooth scrolling for navigation links
    document.querySelectorAll('a[href^="#"]').forEach(link => {
      link.addEventListener('click', function(e) {
        e.preventDefault();
        const targetId = this.getAttribute('href').substring(1);
        const targetElement = document.getElementById(targetId);

        if (targetElement) {
          const headerHeight = document.querySelector('.header').offsetHeight;
          const targetPosition = targetElement.offsetTop - headerHeight - 20;

          window.scrollTo({
            top: targetPosition,
            behavior: 'smooth'
          });
        }
      });
    });

    // Form handling
    const registrationForm = document.getElementById('registrationForm');
    const successMessage = document.getElementById('successMessage');

    if (registrationForm) {
      registrationForm.addEventListener('submit', function(e) {
        e.preventDefault();

        const formData = new FormData(this);

        const registrationData = {
          name: formData.get('name'),
          email: formData.get('email'),
          company: formData.get('company'),
          role: formData.get('role'),
          useCase: formData.get('useCase'),
          languages: formData.get('languages'),
          updates: formData.get('updates') === 'on'
        };

        // Validate
        if (!registrationData.name.trim() || !registrationData.email.trim()) {
          alert('Please fill in all required fields.');
          return;
        }

        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(registrationData.email)) {
          alert('Please enter a valid email address.');
          return;
        }

        // Send email
        const subject = encodeURIComponent('Boltzmann Analyser - New Registration Interest');
        const languagesText = registrationData.languages?.trim() || 'Not specified';
        const body = encodeURIComponent(
          `New registration for Boltzmann Analyser!\n\n` +
          `Name: ${registrationData.name}\n` +
          `Email: ${registrationData.email}\n` +
          `Company: ${registrationData.company || 'Not specified'}\n` +
          `Role: ${registrationData.role || 'Not specified'}\n` +
          `Use Case: ${registrationData.useCase || 'Not specified'}\n` +
          `Programming Languages: ${languagesText}\n` +
          `Wants Updates: ${registrationData.updates ? 'Yes' : 'No'}\n` +
          `Registration Date: ${new Date().toLocaleString()}\n\n` +
          `This registration was submitted via the Boltzmann Analyser website.`
        );

        window.location.href = `mailto:boltzmannanalyser@gmail.com?subject=${subject}&body=${body}`;

        this.style.display = 'none';
        successMessage.style.display = 'block';
        successMessage.scrollIntoView({ behavior: 'smooth', block: 'center' });
      });
    }

    // Header scroll effect
    window.addEventListener('scroll', () => {
      const header = document.querySelector('.header');
      if (window.scrollY > 100) {
        header.style.background = 'rgba(0, 0, 0, 0.98)';
      } else {
        header.style.background = 'rgba(0, 0, 0, 0.95)';
      }
    });

    // Image Modal
    const imageModal = document.getElementById('imageModal');
    const screenshotTrigger = document.getElementById('screenshot-trigger');
    const imageModalClose = document.querySelector('#imageModal .modal-close');

    function openImageModal() {
      imageModal.style.display = 'block';
      document.body.style.overflow = 'hidden';
    }

    function closeImageModal() {
      imageModal.style.display = 'none';
      document.body.style.overflow = 'auto';
    }

    screenshotTrigger?.addEventListener('click', openImageModal);
    imageModalClose?.addEventListener('click', closeImageModal);
    imageModal?.addEventListener('click', (e) => {
      if (e.target === imageModal) closeImageModal();
    });

    // Code Modal
    const codeModal = document.getElementById('code-modal');
    const codeModalContent = document.getElementById('code-modal-content');
    const codeModalClose = document.getElementById('code-modal-close');

    function openCodeModal(codeElement, title) {
      if (window.innerWidth <= 1000) return;

      const codeBlock = codeElement.querySelector('pre code');
      const codeText = codeBlock.textContent;
      const language = codeBlock.className.replace('language-', '');

      codeModalContent.innerHTML = `<code class="language-${language}"></code>`;
      codeModalContent.querySelector('code').textContent = codeText;

      if (typeof Prism !== 'undefined') {
        Prism.highlightElement(codeModalContent.querySelector('code'));
      }

      codeModal.style.display = 'block';
      document.body.style.overflow = 'hidden';
    }

    function closeCodeModal() {
      codeModal.style.display = 'none';
      document.body.style.overflow = 'auto';
    }

    document.querySelectorAll('.code-block').forEach(block => {
      block.addEventListener('click', () => {
        openCodeModal(block, block.dataset.title);
      });
    });

    codeModalClose?.addEventListener('click', closeCodeModal);
    codeModal?.addEventListener('click', (e) => {
      if (e.target === codeModal) closeCodeModal();
    });

    // Escape to close modals
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        closeImageModal();
        closeCodeModal();
      }
    });

    // Initialize Prism
    if (typeof Prism !== 'undefined') {
      Prism.highlightAll();
    }
  </script>
</BaseLayout>
